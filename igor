#!/usr/bin/env bash
set -euo pipefail

IGOR_HOME="${IGOR_HOME:-${HOME}/.igor}"
IGOR_VERSION="1.0.0"

export IGOR_HOME IGOR_VERSION

source "${IGOR_HOME}/lib/config.sh" 2>/dev/null || true
source "${IGOR_HOME}/lib/session.sh" 2>/dev/null || true
source "${IGOR_HOME}/lib/memory.sh" 2>/dev/null || true
source "${IGOR_HOME}/lib/prompt.sh" 2>/dev/null || true
source "${IGOR_HOME}/lib/diagnostics.sh" 2>/dev/null || true
source "${IGOR_HOME}/lib/fixer.sh" 2>/dev/null || true

show_help() {
    cat << 'EOF'
Igor v1.0 - Autonomous System Agent

Usage: igor [FLAGS] <task or question>

Igor understands natural language requests and autonomously diagnoses and fixes system issues.

FLAGS:
  --diagnose [type]   Run diagnostics without fixing
  --dry-run           Show what would be fixed without executing
  --memory            Show learned system knowledge
  --memory edit       Edit system knowledge
  --clear-history     Clear history of fixed issues
  --help              Show this help
  --version           Show version

EXAMPLES:
  igor fix my permissions issues with .ssh
  igor why is my docker service crashing
  igor diagnose my disk space problems
  igor my nginx server won't start
  igor what services are failing
  igor show me performance issues
  igor audit my system

EOF
}

show_version() {
    echo "Igor v${IGOR_VERSION} - Autonomous System Agent"
}

diagnose_mode() {
    local diagnose_type="${1:-general}"
    shift || true
    
    echo "üîç Diagnosing: $diagnose_type"
    echo ""
    
    case "$diagnose_type" in
        services)
            diagnose_services
            ;;
        disk)
            diagnose_disk
            ;;
        permissions)
            diagnose_permissions "${1:-.}"
            ;;
        network)
            diagnose_network
            ;;
        processes)
            diagnose_processes "${1:-}"
            ;;
        logs)
            diagnose_logs "${1:-}"
            ;;
        docker)
            diagnose_docker
            ;;
        health)
            diagnose_system_health
            ;;
        *)
            diagnose_system_health
            diagnose_logs
            ;;
    esac
    
    echo ""
    echo "üí° Run 'igor <issue>' to get fix suggestions"
}

run_agent() {
    local user_task="$*"
    
    init_memory
    init_default_config
    
    echo "ü§ñ Igor - System Agent"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "Task: $user_task"
    echo ""
    
    local knowledge=$(get_system_knowledge 2>/dev/null || echo "")
    
    local system_prompt="You are Igor, an autonomous Linux system diagnostics and repair agent.

CORE RESPONSIBILITIES:
1. Understand problems from natural language descriptions
2. Run appropriate system diagnostics
3. Identify root causes
4. Explain findings clearly
5. Suggest fixes
6. Ask for confirmation before major changes
7. Execute approved fixes
8. Verify results

AUTO-APPROVE (no confirmation):
- Viewing files and logs
- Checking service status
- Restarting failed services
- Fixing permissions (e.g., chmod 600 ~/.ssh/id_rsa)
- Package list updates

ALWAYS CONFIRM:
- Deleting files
- Modifying /etc or /root
- Package installs/removals
- Destructive operations

THINKING STYLE:
- Be analytical and thorough
- Explain your reasoning
- Consider multiple potential causes
- Suggest preventive measures
- Learn from each issue"

    if [[ -n "$knowledge" ]]; then
        system_prompt+="

SYSTEM KNOWLEDGE (learned from past sessions):
$knowledge"
    fi

    opencode run --prompt "$system_prompt" "$user_task"
}

main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi
    
    case "$1" in
        --help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            show_version
            exit 0
            ;;
        --diagnose)
            shift
            diagnose_mode "${1:-health}" "${2:-}"
            exit 0
            ;;
        --dry-run)
            shift
            echo "‚ö†Ô∏è  DRY RUN MODE - Changes will not be executed"
            echo ""
            run_agent "$@"
            exit 0
            ;;
        --memory)
            shift
            if [[ "${1:-}" == "edit" ]]; then
                mkdir -p "${IGOR_HOME}/memory/system"
                ${EDITOR:-nano} "${IGOR_HOME}/memory/system/knowledge.md"
            else
                echo "=== System Knowledge Base ==="
                get_system_knowledge 2>/dev/null || echo "(empty)"
            fi
            exit 0
            ;;
        --clear-history)
            rm -f "${IGOR_HOME}/memory/issues/fixed.log"
            echo "Issue history cleared"
            exit 0
            ;;
        *)
            run_agent "$@"
            exit 0
            ;;
    esac
}

main "$@"
